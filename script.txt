#!/bin/bash

# BASE_DIR: diretório para salvar os dumps de memória.
BASE_DIR='memory'

# verifica se o gdb está instalado.
if ! command -v gdb &> /dev/null; then
	echo "Erro: gdb não encontrado. Falha ao realizar o dump de memória."
	exit 1
fi

# cria o diretório base, se não existir.
mkdir -p "$BASE_DIR"

# obtém os PIDs de todos os processos em execução.
pids=$(ps aux | awk 'NR>1 {print $2}')

# loop através de cada PID.
for pid in $pids; do
	echo "Dump da memória do PID: $pid"
	mkdir -p "$BASE_DIR/$pid"

	# obtém as regiões de memória RW (leitura/escrita) e faz o dump.
	grep 'rw-p' "/proc/$pid/maps" |
	sed -n 's/^\([0-9a-f]*\)-\([0-9a-f]*\) .*$/\1 \2/p' |
	while read start stop; do
		gdb --batch --pid "$pid" -ex "dump memory \"$BASE_DIR/$pid/$pid-$start-$stop\" 0x$start 0x$stop"
	done
	echo "Dump concluído para o PID: $pid"
done

echo "Processo de dump de memória CONCLUÍDO."
